<!doctype html>
<html lang="en" ng-app="demo">
<head>
<title>Show viewer demo</title>
<meta charset="utf8">
<base href="../">
<!-- ETV stylesheet -->
<link rel="stylesheet" href="http://etv.err.ee/Content/less/theme/etv/bootstrap.less">
<!-- Dependencies -->
<link rel="stylesheet" href="bower_components/fontawesome/css/font-awesome.css">
<script src="bower_components/jquery/dist/jquery.min.js"></script>
<script src="bower_components/moment/min/moment-with-locales.min.js"></script>
<script src="bower_components/angular/angular.min.js"></script>
<script src="bower_components/underscore/underscore-min.js"></script>
<script src="bower_components/angular-touch/angular-touch.min.js"></script>
<script src="bower_components/hamsterjs/hamster.js"></script>
<script src="bower_components/angular-mousewheel/mousewheel.js"></script>
<script src="bower_components/angular-bootstrap/ui-bootstrap-tpls.min.js"></script>
<!-- Language -->
<script src="../language/module.js"></script>
<script src="../language/language-service.js"></script>
<!-- Apis -->
<script src="../err/module.js"></script>
<script src="../err/apis.js"></script>
<script src="../err/show-viewer-adapter.js"></script>
<script src="../err/timeline-adapter.js"></script>
<script src="../err/now-playing-adapter.js"></script>
<!-- Timeline -->
<link rel="stylesheet/less" href="../timeline/style.less" type="text/css">
<script src="../timeline/module.js"></script>
<script src="../timeline/timeline-locale.js"></script>
<script src="../timeline/timeline-service.js"></script>
<script src="../timeline/timeline-filters.js"></script>
<script src="../timeline/timeline-controller.js"></script>
<script src="../timeline/timeline-directive.js"></script>
<script src="../timeline/days-directive.js"></script>
<script src="../timeline/day-directive.js"></script>
<script src="../timeline/items-directive.js"></script>
<!-- Show viewer -->
<link rel="stylesheet/less" href="../show-viewer/style.less" type="text/css">
<script src="../show-viewer/module.js"></script>
<script src="../show-viewer/show-viewer-locale.js"></script>
<script src="../show-viewer/show-viewer-directive.js"></script>
<script src="../show-viewer/show-viewer-filters.js"></script>
<!-- Templates -->
<script>
	/*
	 * These synchronous template GET is not required if you use the bundled form
	 * of the timeline plugin
	 */
	angular.module('battlesnake.timeline')
		.run(function ($templateCache) {
			var templates = [
				'timeline',
				'show-viewer'
			];
			templates.forEach(function (template) {
				var xhr = new XMLHttpRequest();
				var name = template + '-template.html';
				var path = '../' + template + '/' + name;
				xhr.open('GET', path, false);
				xhr.send();
				$templateCache.put(name, xhr.responseText);
			});
		});
</script>
<!-- Schedule -->
<link rel="stylesheet/less" href="style.less" type="text/css">
<script src="module.js"></script>
<script src="schedule-directive.js"></script>
<script src="schedule-controller.js"></script>
<!-- Demo -->
<script>
(function (angular) {
	'use strict';

	angular.module('demo', ['battlesnake.schedule', 'battlesnake.err'])
		.controller('demoController', demoController);

	function demoController($scope, $q, $timeout, $window, showViewerAdapterFactory, timelineAdapterFactory, nowPlayingAdapterFactory, scheduleApi) {
		$scope.adapters = _(scheduleApi).map(function (api, name) {
			return {
				name: name,
				showViewer: showViewerAdapterFactory(api),
				timeline: timelineAdapterFactory(api),
				nowPlaying: nowPlayingAdapterFactory(api)
			};
		});
		$scope.model = {
			title: 'Show viewer demo with timeline binding',
			adapter: null,
			nowPlaying: null,
			expanded: false,
			item: null
		};
		$scope.model.adapter = $scope.adapters[0];
		$scope.changeChannel = changeChannel;
		var nowPlayingTimer = null;
		changeChannel();
		var query = _($window.location.search.substr(1).split('&')).chain()
			.map(function (kv) {
				var eq = kv.indexOf('=');
				return eq === -1 ? [kv, true] : [kv.substr(0, eq), kv.substr(eq + 1)];
			})
			.object()
			.value();
		if (query.channel) {
			$scope.model.adapter = _($scope.adapters)
				.findWhere({ name: query.channel }) || $scope.model.adapter;
		}
		if (query.showlive) {
			showCurrent();
		}
		return;
		
		function changeChannel() {
			$scope.model.show = null;
			$timeout.cancel(nowPlayingTimer);
			updateNowPlaying();
		}

		function updateNowPlaying() {
			var adapter = $scope.model.adapter;
			if (!adapter.nowPlaying) {
				return;
			}
			adapter.nowPlaying()
				.then(function parseResponse(res) {
					return (res.data || '').replace(/^[\r\n\s]+|[\r\n\s]+$|^null$/gi, '');
				}, function clearValue() {
					return '';
				})
				.then(showNowPlaying);
			return;

			function showNowPlaying(value) {
				var changed = $scope.model.nowPlaying !== value;
				$scope.model.nowPlaying = value;
				nowPlayingTimer = $timeout(updateNowPlaying, changed ? 30000 : 5000);
			}
		}

		function showCurrent() {
			$scope.model.adapter.timeline.getDay(moment())
				.then(getCurrent)
				.then(function selectShow(show) {
					$scope.model.item = show.itemData;
					$scope.model.expanded = true;
				});
				
			function getCurrent(data) {
				return _(data).chain()
					.sort(showReverseComparator)
					.find(hasStartedPredicate)
					.value();
					
				function showReverseComparator(a, b) {
					return -a.start.diff(b.start);
				}

				function hasStartedPredicate(show) {
					return show.start.isBefore(moment());
				}
			}
		}
	}

})(window.angular);
</script>
<style>
body {
	font-family: sans-serif;
	margin: 60px 0;
	overflow-y: scroll;
}
.header,
.timeline,
.show-viewer {
	border-left: 1px solid #aaa;
	border-right: 1px solid #aaa;
	box-shadow: 0px 0px 12px 3px rgba(90, 90, 90, 0.5);
}
.header>* {
	margin: 60px;
	display: block;
}
.header {
	border-top: 1px solid #aaa;
}
.schedule .show-viewer {
	border-bottom: 1px solid #aaa;
}
</style>
</head>
<body ng-controller="demoController">
<div class="page">
	<!-- Some slight abuse of bootstrap -->
	<div class="container header">
		<h1 ng-bind="model.title" id="title"></h1>
		<div style="padding-left: 30px">
			<strong>Channel&nbsp;</strong>
			<select ng-options="adapter as adapter.name for adapter in adapters" ng-model="model.adapter" ng-change="changeChannel()"></select>
		</div>
	</div>
	<div schedule="model.adapter" class="schedule kartulita"
		expanded="model.expanded" selected-item="model.item"
		timeline-class="" show-viewer-class="container"
		now-playing="model.nowPlaying"></div>
	<!-- That's all there is to it! -->
</div>
<div>
	<p style="margin: 2em auto 1em; max-width: 600px; line-height: 1.7em;">
		<strong>NOTE:</strong> Since we are using the err.ee api from
		outside the err.ee domain, your browser will block the XHRs due to
		CORS. To disable CORS in chrome or chromium, launch it with the
		<b>--disable-web-security</b> command-line parameter. The demos will
		not work otherwise. There is no reliable way to disable CORS in
		Firefox.
	</p>
</div>
</body>
<script src="bower_components/less/dist/less.min.js"></script>
</html>
